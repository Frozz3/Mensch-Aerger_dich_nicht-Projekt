<!DOCTYPE html>
<html>

<head>
    <title>Socket.IO chat</title>
    <style>
        body {
            margin: 0;
            padding-bottom: 3rem;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        .form {
            background: rgba(0, 0, 0, 0.15);
            padding: 0.25rem;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 50%;
            display: flex;
            height: 3rem;
            box-sizing: border-box;
            backdrop-filter: blur(10px);
        }

        #form1 {
            left: 0;
            right: 50%;
        }

        #form2 {
            left: 50%;
            right: 0;
        }

        .input {
            border: none;
            padding: 0 1rem;
            flex-grow: 1;
            border-radius: 2rem;
            margin: 0.25rem;
        }

        .input:focus {
            outline: none;
        }

        .form>button {
            background: #333;
            border: none;
            padding: 0 1rem;
            margin: 0.25rem;
            border-radius: 3px;
            outline: none;
            color: #fff;
        }

        #messages {
            list-style-type: none;
            margin: 0;
            padding: 0;
            width: 50%;
        }

        #messages>li {
            padding: 0.5rem 1rem;
        }

        #info {
            position: absolute;
            list-style-type: none;
            margin: 0;
            margin-left: 50%;
            padding: 0;
            width: 50%;
            height: 50%;
            overflow: auto;
        }

        #info>li {
            padding: 0.5rem 1rem;
        }


        #messages>li:nth-child(odd) {
            background: #efefef;
        }
    </style>
</head>

<body>
    <ul id="info"></ul>
    <ul id="messages"></ul>
    <form class="form" id="form1" action="">
        <input class="input" id="input1" autocomplete="off" placeholder="message" />
        <button id="sendMessage">Send message</button>
    </form>
    <form class="form" id="form2" action="">
        <input class="input" id="input2" autocomplete="off" placeholder="roomid" />
        <button id="enterRoom">enter room</button>
        <button id="createRoom">create room</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script>


        var info = document.getElementById('info');
        var clients = document.getElementById('clients');
        var msgForm = document.getElementById('form1');
        var msgInput = document.getElementById('input1');
        var roomForm = document.getElementById('form2');
        var roomInput = document.getElementById('input2');
        var sendMessage = document.getElementById('sendMessage');
        var enterRoom = document.getElementById('enterRoom');
        var createRoom = document.getElementById('createRoom');

        //authentication

        authenticationId = localStorage.getItem('authId');

        var socket = io({ auth: { token: authenticationId } });

        socket.on('new authenticationId', function (authenticationId) {
            console.log("authenticationId saved: " + authenticationId);
            localStorage.setItem('authId', authenticationId);
        });
        socket.emit('request authenticationId');
        //handle pathname

        pathnameArr = window.location.pathname.split("/");
        roomid = pathnameArr[pathnameArr.length - 1];
        if (roomid) {
            socket.emit('change room', roomid);
            console.log('roomid: ' + roomid);
        }

        //messages

        sendMessage.addEventListener('click', function (e) {
            e.preventDefault();
            if (msgInput.value) {
                socket.emit('chat message', msgInput.value);
                msgInput.value = '';
            }
        });

        socket.on('chat message', function (msg) {
            var item = document.createElement('li');
            item.textContent = msg;
            //messages.appendChild(item);
            messages.insertAdjacentElement('afterbegin', item);
            //window.scrollTo(0, document.body.scrollHeight);
        });



        //Rooms

        enterRoom.addEventListener('click', function (e) {
            e.preventDefault();
            if (roomInput.value) {
                socket.emit('change room', roomInput.value);
                roomInput.value = '';
            }
        });

        createRoom.addEventListener('click', function (e) {
            e.preventDefault();
            socket.emit('create room', '');
        });

        socket.on('info update', function (msgs) {
            console.log('info update');
            console.log(history);
            history.replaceState({}, null, 'http://localhost:3000/game/' + msgs[0]);
            console.log(history);
            info.textContent = '';
            var item = document.createElement('a');
            item.textContent = 'http://localhost:3000/game/' + msgs[0];
            info.appendChild(item);
            for (var msg in msgs[1]) {
                var item1 = document.createElement('li');
                item1.textContent = '> ' + msg + ':';
                info.appendChild(item1);
                var item2 = document.createElement('li');
                item2.textContent = '>> [' + msgs[1][msg] + ']';
                info.appendChild(item2);
            };
            var item = document.createElement('li');
            item.textContent = '->' + socket.id;
            info.appendChild(item);
        });

        socket.on('change site', function (msg) {
            socket = io('http://localhost:3000/' + msg)
        });
    </script>
</body>

</html>